---
import Layout from '../../layouts/Layout.astro';
import JobPage from '../../components/JobPage.svelte';
import type { Job } from '../../lib/types';

const { id } = Astro.params;
const url = new URL(Astro.request.url);
const skipSSR = url.searchParams.has('mock');

// Fetch initial job state from backend (skip for client-side-only mode used in tests)
const BACKEND_URL = import.meta.env.BACKEND_URL || 'http://localhost:8000';
let job: Job | null = null;
let error: string | null = null;

if (!skipSSR) {
  try {
    const response = await fetch(`${BACKEND_URL}/api/jobs/${id}`);
    if (response.ok) {
      job = await response.json();
    } else if (response.status === 404) {
      error = 'Job not found';
    } else {
      error = `Failed to load job: HTTP ${response.status}`;
    }
  } catch (e) {
    error = 'Failed to connect to backend. Is the API server running?';
  }
}
---

<Layout title={`Job ${id?.slice(0, 8)}...`}>
  <div class="job-page">
    <header class="job-header">
      <a href="/" class="back-link">&larr; New Job</a>
      <h1>Job Progress</h1>
      <p class="job-id">ID: {id}</p>
    </header>

    {error && (
      <div class="error card">
        <div class="error-icon">üîç</div>
        <h2>Job Not Found</h2>
        <p>This job may have expired or the server was restarted.</p>
        <a href="/" class="btn-primary">Start a New Job</a>
      </div>
    )}

    {!error && job && (
      <JobPage
        client:load
        jobId={id!}
        initialJob={job}
      />
    )}

    {/* Client-side only mode for E2E tests with mocked responses */}
    {!error && !job && skipSSR && (
      <JobPage
        client:load
        jobId={id!}
      />
    )}

    {!error && !job && !skipSSR && (
      <div class="loading card">
        <p>Loading job status...</p>
      </div>
    )}
  </div>
</Layout>

<style>
  .job-page {
    max-width: 1000px;
    margin: 0 auto;
  }

  .job-header {
    margin-bottom: 2rem;
  }

  .back-link {
    display: inline-block;
    margin-bottom: 1rem;
    color: var(--color-text-muted);
    text-decoration: none;
    font-size: 0.9rem;
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .job-header h1 {
    margin-bottom: 0.25rem;
  }

  .job-id {
    color: var(--color-text-muted);
    font-family: monospace;
    font-size: 0.9rem;
  }

  .loading {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-muted);
  }

  .error {
    text-align: center;
    background: rgba(239, 68, 68, 0.1);
    border-color: var(--color-error);
  }

  .error h2 {
    color: var(--color-error);
    margin-bottom: 0.5rem;
  }

  .error p {
    margin-bottom: 1rem;
  }
  
  .error-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }
  
  .btn-primary {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: var(--color-primary);
    color: white;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
</style>
